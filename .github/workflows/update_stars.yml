name: Update GitHub Stars

# å·¥ä½œæµè§¦å‘æ¡ä»¶
on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯å¤©UTCæ—¶é—´3ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´11ç‚¹ï¼‰
  schedule:
    - cron: '0 3 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      fetch_mode:
        description: 'è·å–æ¨¡å¼ (incremental: å¢é‡æ›´æ–°, full: å…¨é‡æ›´æ–°)'
        required: true
        default: 'incremental'
        type: choice
        options:
          - incremental
          - full
      force_full_fetch:
        description: 'å¼ºåˆ¶å…¨é‡è·å–ï¼ˆå¿½ç•¥fetch_modeè®¾ç½®ï¼‰'
        required: false
        default: false
        type: boolean
      max_repositories:
        description: 'æœ€å¤§è·å–ä»“åº“æ•°é‡ï¼ˆå¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é…ç½®æ–‡ä»¶é»˜è®¤å€¼ï¼‰'
        required: false
        type: string
      skip_classification:
        description: 'è·³è¿‡AIåˆ†ç±»æ­¥éª¤'
        required: false
        default: false
        type: boolean

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.11'  # å‡çº§åˆ°æ›´æ–°çš„Pythonç‰ˆæœ¬ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½
  REQUIREMENTS_FILE: 'requirements.txt'
  PIP_CACHE_DIR: ~/.cache/pip  # è®¾ç½®pipç¼“å­˜ç›®å½•

# ä½œä¸šå®šä¹‰
jobs:
  update-stars:
    name: æ›´æ–°GitHub Staré¡¹ç›®
    runs-on: ubuntu-latest
    
    # è¶…æ—¶è®¾ç½®ï¼ˆé˜²æ­¢å·¥ä½œæµæ— é™è¿è¡Œï¼‰
    timeout-minutes: 60
    
    # å¹¶å‘æ§åˆ¶ï¼ˆç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå®ä¾‹è¿è¡Œï¼‰
    concurrency:
      group: update-stars-${{ github.ref }}
      cancel-in-progress: false
    
    # æƒé™è®¾ç½®
    permissions:
      contents: write
      actions: read
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1  # æµ…å…‹éš†ä»¥æé«˜æ€§èƒ½ï¼Œé™¤ééœ€è¦å®Œæ•´å†å²è®°å½•
          persist-credentials: true
      
      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ${{ env.REQUIREMENTS_FILE }}
      
      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip setuptools wheel
          if [ -f ${{ env.REQUIREMENTS_FILE }} ]; then
            pip install -r ${{ env.REQUIREMENTS_FILE }} --no-warn-script-location
          else
            echo "âš ï¸ requirements.txt not found, installing basic dependencies"
            pip install requests PyYAML --no-warn-script-location
          fi
          
          # éªŒè¯å…³é”®ä¾èµ–æ˜¯å¦å®‰è£…æˆåŠŸ
          python -c "import requests, yaml; print('âœ… æ ¸å¿ƒä¾èµ–éªŒè¯é€šè¿‡')"
      
      # 4. éªŒè¯ç¯å¢ƒå˜é‡
      - name: ğŸ” éªŒè¯ç¯å¢ƒé…ç½®
        run: |
          python src/env_check.py --secrets-only ${{ github.event.inputs.skip_classification == 'true' && '--skip-classification' || '' }}
      
      # 5. å¥åº·æ£€æŸ¥
      - name: ğŸ¥ ç³»ç»Ÿå¥åº·æ£€æŸ¥
        run: |
          python src/env_check.py --health-check ${{ github.event.inputs.skip_classification == 'true' && '--skip-classification' || '' }}
      
      # 6. åˆ›å»ºå¿…è¦çš„ç›®å½•
      - name: ğŸ“ åˆ›å»ºç›®å½•ç»“æ„
        run: |
          python src/workflow_utils.py create-dirs
      
      # 7. è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒå˜é‡
      - name: âš™ï¸ é…ç½®è¿è¡Œç¯å¢ƒ
        run: |
          # ç¡®å®šè·å–æ¨¡å¼
          if [ "${{ github.event.inputs.force_full_fetch }}" = "true" ]; then
            echo "FETCH_MODE=full" >> $GITHUB_ENV
            echo "ğŸ”„ å¼ºåˆ¶å…¨é‡è·å–æ¨¡å¼"
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            echo "FETCH_MODE=incremental" >> $GITHUB_ENV
            echo "â° å®šæ—¶ä»»åŠ¡ - å¢é‡æ›´æ–°æ¨¡å¼"
          elif [ -n "${{ github.event.inputs.fetch_mode }}" ]; then
            echo "FETCH_MODE=${{ github.event.inputs.fetch_mode }}" >> $GITHUB_ENV
            echo "ğŸ‘¤ æ‰‹åŠ¨è§¦å‘ - ${{ github.event.inputs.fetch_mode }}æ¨¡å¼"
          else
            echo "FETCH_MODE=incremental" >> $GITHUB_ENV
            echo "ğŸ“ é»˜è®¤ - å¢é‡æ›´æ–°æ¨¡å¼"
          fi
          
          # è®¾ç½®æœ€å¤§ä»“åº“æ•°é‡
          if [ -n "${{ github.event.inputs.max_repositories }}" ]; then
            echo "MAX_REPOSITORIES=${{ github.event.inputs.max_repositories }}" >> $GITHUB_ENV
            echo "ğŸ“Š è‡ªå®šä¹‰æœ€å¤§ä»“åº“æ•°é‡: ${{ github.event.inputs.max_repositories }}"
          fi
          
          # è®¾ç½®å…¶ä»–ç¯å¢ƒå˜é‡ï¼ˆä½¿ç”¨æ©ç ä¿æŠ¤æ•æ„Ÿä¿¡æ¯ï¼‰
          echo "GH_PAT=${{ secrets.GH_PAT }}" >> $GITHUB_ENV
          echo "GITHUB_USERNAME=${{ github.actor }}" >> $GITHUB_ENV
          
          # åªåœ¨éœ€è¦æ—¶è®¾ç½®AIç›¸å…³ç¯å¢ƒå˜é‡
          if [ "${{ github.event.inputs.skip_classification }}" != "true" ]; then
            echo "AI_API_KEY=${{ secrets.AI_API_KEY }}" >> $GITHUB_ENV
            echo "AI_ACCOUNT_ID=${{ secrets.AI_ACCOUNT_ID }}" >> $GITHUB_ENV
          fi
          
          # è®¾ç½®å®‰å…¨ç›¸å…³ç¯å¢ƒå˜é‡
          echo "PYTHONUNBUFFERED=1" >> $GITHUB_ENV  # ç¡®ä¿Pythonè¾“å‡ºä¸è¢«ç¼“å†²
          echo "PYTHONDONTWRITEBYTECODE=1" >> $GITHUB_ENV  # ä¸ç”Ÿæˆ.pycæ–‡ä»¶
          
          echo "âœ… ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ"
      
      # 8. è·å–Staré¡¹ç›®æ•°æ®
      - name: â­ è·å–GitHub Staré¡¹ç›®
        timeout-minutes: 30
        run: |
          echo "ğŸš€ å¼€å§‹è·å–GitHub Staré¡¹ç›®..."
          echo "ğŸ“‹ è·å–æ¨¡å¼: $FETCH_MODE"
          
          # æ·»åŠ é‡è¯•æœºåˆ¶
          retry_count=0
          max_retries=3
          
          while [ $retry_count -lt $max_retries ]; do
            if python src/fetch_stars.py; then
              echo "âœ… Staré¡¹ç›®è·å–æˆåŠŸ"
              
              # æ˜¾ç¤ºè·å–ç»Ÿè®¡
              python src/stats.py project_stats
              break
            else
              retry_count=$((retry_count + 1))
              if [ $retry_count -lt $max_retries ]; then
                echo "âš ï¸ è·å–å¤±è´¥ï¼Œç­‰å¾…30ç§’åé‡è¯• ($retry_count/$max_retries)..."
                sleep 30
              else
                echo "âŒ Staré¡¹ç›®è·å–å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
                exit 1
              fi
            fi
          done
      
      # 9. AIåˆ†ç±»å¤„ç†
      - name: ğŸ¤– AIæ™ºèƒ½åˆ†ç±»
        if: github.event.inputs.skip_classification != 'true'
        timeout-minutes: 45
        run: |
          echo "ğŸ§  å¼€å§‹AIæ™ºèƒ½åˆ†ç±»..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦åˆ†ç±»çš„é¡¹ç›®
          if [ -f "data/stars_data.json" ]; then
            unclassified_count=$(python src/stats.py unclassified)
            
            if [ "$unclassified_count" -eq "0" ]; then
              echo "ğŸ“ æ‰€æœ‰é¡¹ç›®å·²åˆ†ç±»ï¼Œè·³è¿‡AIåˆ†ç±»æ­¥éª¤"
            else
              echo "ğŸ“Š å‘ç° $unclassified_count ä¸ªæœªåˆ†ç±»é¡¹ç›®ï¼Œå¼€å§‹AIåˆ†ç±»..."
              
              # æ·»åŠ é‡è¯•æœºåˆ¶
              retry_count=0
              max_retries=2
              
              while [ $retry_count -lt $max_retries ]; do
                if python src/classify.py; then
                  echo "âœ… AIåˆ†ç±»å®Œæˆ"
                  
                  # æ˜¾ç¤ºåˆ†ç±»ç»Ÿè®¡
                  python src/stats.py classification
                  break
                else
                  retry_count=$((retry_count + 1))
                  if [ $retry_count -lt $max_retries ]; then
                    echo "âš ï¸ AIåˆ†ç±»å¤±è´¥ï¼Œç­‰å¾…60ç§’åé‡è¯• ($retry_count/$max_retries)..."
                    sleep 60
                  else
                    echo "âŒ AIåˆ†ç±»å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
                    exit 1
                  fi
                fi
              done
            fi
          else
            echo "âŒ æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡AIåˆ†ç±»"
          fi
      
      # 10. ç”Ÿæˆåˆ†ç±»æ–‡æ¡£
      - name: ğŸ“ ç”Ÿæˆåˆ†ç±»æ–‡æ¡£
        run: |
          echo "ğŸ“š å¼€å§‹ç”Ÿæˆåˆ†ç±»æ–‡æ¡£..."
          
          python src/generate_category_docs.py
          
          if [ $? -eq 0 ]; then
            echo "âœ… åˆ†ç±»æ–‡æ¡£ç”ŸæˆæˆåŠŸ"
            
            # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡æ¡£
            if [ -d "docs" ]; then
              doc_count=$(find docs -name "*.md" -type f | wc -l)
              echo "ğŸ“„ ç”Ÿæˆæ–‡æ¡£æ•°é‡: $doc_count"
              echo "ğŸ“‹ ç”Ÿæˆçš„æ–‡æ¡£:"
              find docs -name "*.md" -type f -exec basename {} \; | sort
            fi
          else
            echo "âŒ åˆ†ç±»æ–‡æ¡£ç”Ÿæˆå¤±è´¥"
            exit 1
          fi
      
      # 11. æ›´æ–°README
      - name: ğŸ“– æ›´æ–°READMEæ–‡ä»¶
        run: |
          echo "ğŸ“ å¼€å§‹æ›´æ–°README..."
          
          python src/update_readme.py
          
          if [ $? -eq 0 ]; then
            echo "âœ… READMEæ›´æ–°æˆåŠŸ"
          else
            echo "âŒ READMEæ›´æ–°å¤±è´¥"
            exit 1
          fi
      
      # 12. æ£€æŸ¥æ–‡ä»¶å˜æ›´
      - name: ğŸ” æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: check_changes
        run: |
          echo "ğŸ” æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
          python src/workflow_utils.py check-changes
      
      # 13. æäº¤å˜æ›´
      - name: ğŸ’¾ æäº¤å˜æ›´
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ’¾ æäº¤æ–‡ä»¶å˜æ›´..."
          python src/workflow_utils.py commit-changes "$FETCH_MODE" "${{ github.event_name }}" "${{ github.run_number }}" "${{ github.event.inputs.skip_classification }}"
      
      # 14. æ¨é€å˜æ›´
      - name: ğŸš€ æ¨é€å˜æ›´
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸš€ æ¨é€å˜æ›´åˆ°è¿œç¨‹ä»“åº“..."
          python src/workflow_utils.py push-changes
      
      # 15. ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
      - name: ğŸ“Š ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
        if: always()
        run: |
          echo "ğŸ“Š ç”Ÿæˆæ‰§è¡Œæ‘˜è¦..."
          python src/workflow_utils.py summary "${{ github.event.created_at }}" "$FETCH_MODE" "${{ github.event_name }}" "${{ github.run_number }}" "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" "${{ github.event.inputs.skip_classification }}" "${{ steps.check_changes.outputs.has_changes }}"
      
      # 16. é”™è¯¯å¤„ç†å’Œæ¸…ç†
      - name: ğŸ§¹ æ¸…ç†å’Œé”™è¯¯å¤„ç†
        if: failure()
        run: |
          echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥ï¼Œå¼€å§‹è¯Šæ–­å’Œæ¸…ç†..."
          
          # æ˜¾ç¤ºå¤±è´¥çš„æ­¥éª¤ä¿¡æ¯
          echo "ğŸ” å¤±è´¥è¯Šæ–­:"
          echo "  - å¤±è´¥æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "  - è¿è¡Œç¼–å·: ${{ github.run_number }}"
          echo "  - è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          
          # æ˜¾ç¤ºé”™è¯¯æ—¥å¿—
          if [ -d "logs" ]; then
            echo "ğŸ“‹ åº”ç”¨é”™è¯¯æ—¥å¿—:"
            find logs -name "*.log" -type f -exec echo "=== {} ===" \; -exec head -50 {} \;
          else
            echo "ğŸ“‹ æ²¡æœ‰æ‰¾åˆ°åº”ç”¨æ—¥å¿—ç›®å½•"
          fi
          
          # æ£€æŸ¥æ•°æ®æ–‡ä»¶çŠ¶æ€
          echo "ğŸ“Š æ•°æ®æ–‡ä»¶çŠ¶æ€:"
          if [ -f "data/stars_data.json" ]; then
            echo "  - stars_data.json: å­˜åœ¨ ($(stat -c%s data/stars_data.json 2>/dev/null || stat -f%z data/stars_data.json) bytes)"
          else
            echo "  - stars_data.json: ä¸å­˜åœ¨"
          fi
          
          # æ£€æŸ¥ç½‘ç»œè¿æ¥
          echo "ğŸŒ ç½‘ç»œè¿æ¥æµ‹è¯•:"
          if curl -s --max-time 10 https://api.github.com > /dev/null; then
            echo "  - GitHub API: âœ… å¯è®¿é—®"
          else
            echo "  - GitHub API: âŒ æ— æ³•è®¿é—®"
          fi
          
          # æ˜¾ç¤ºPythonç¯å¢ƒä¿¡æ¯
          echo "ğŸ Pythonç¯å¢ƒä¿¡æ¯:"
          python --version
          echo "  - å·²å®‰è£…åŒ…:"
          pip list | head -20
          
          # æ˜¾ç¤ºç³»ç»Ÿèµ„æºä¿¡æ¯
          echo "ğŸ’» ç³»ç»Ÿèµ„æºä¿¡æ¯:"
          echo "  - ç³»ç»Ÿ: $(uname -s) $(uname -r)"
          echo "  - ç£ç›˜ç©ºé—´: $(df -h . | tail -1 | awk '{print $4}') å¯ç”¨"
          echo "  - å†…å­˜: $(free -h | grep '^Mem:' | awk '{print $7}') å¯ç”¨"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          find . -name "*.tmp" -type f -delete 2>/dev/null || true
          find . -name "*.pyc" -type f -delete 2>/dev/null || true
          find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          
          echo "ğŸ§¹ æ¸…ç†å®Œæˆ"