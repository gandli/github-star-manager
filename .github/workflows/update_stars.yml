name: Update GitHub Stars

# å·¥ä½œæµè§¦å‘æ¡ä»¶
on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯å¤©UTCæ—¶é—´3ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´11ç‚¹ï¼‰
  schedule:
    - cron: '0 3 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      fetch_mode:
        description: 'è·å–æ¨¡å¼ (incremental: å¢é‡æ›´æ–°, full: å…¨é‡æ›´æ–°)'
        required: true
        default: 'incremental'
        type: choice
        options:
          - incremental
          - full
      force_full_fetch:
        description: 'å¼ºåˆ¶å…¨é‡è·å–ï¼ˆå¿½ç•¥fetch_modeè®¾ç½®ï¼‰'
        required: false
        default: false
        type: boolean
      max_repositories:
        description: 'æœ€å¤§è·å–ä»“åº“æ•°é‡ï¼ˆå¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é…ç½®æ–‡ä»¶é»˜è®¤å€¼ï¼‰'
        required: false
        type: string
      skip_classification:
        description: 'è·³è¿‡AIåˆ†ç±»æ­¥éª¤'
        required: false
        default: false
        type: boolean

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.9'
  REQUIREMENTS_FILE: 'requirements.txt'

# ä½œä¸šå®šä¹‰
jobs:
  update-stars:
    name: æ›´æ–°GitHub Staré¡¹ç›®
    runs-on: ubuntu-latest
    
    # æƒé™è®¾ç½®
    permissions:
      contents: write
      actions: read
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          if [ -f ${{ env.REQUIREMENTS_FILE }} ]; then
            pip install -r ${{ env.REQUIREMENTS_FILE }}
          else
            echo "âš ï¸ requirements.txt not found, installing basic dependencies"
            pip install requests PyYAML
          fi
      
      # 4. éªŒè¯ç¯å¢ƒå˜é‡
      - name: ğŸ” éªŒè¯ç¯å¢ƒé…ç½®
        run: |
          echo "ğŸ”§ æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡..."
          
          # æ£€æŸ¥GitHubç›¸å…³å˜é‡
          if [ -z "${{ secrets.GH_PAT }}" ]; then
            echo "âŒ GH_PAT secret is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.GITHUB_USERNAME }}" ]; then
            echo "âŒ GITHUB_USERNAME secret is not set"
            exit 1
          fi
          
          # æ£€æŸ¥AIç›¸å…³å˜é‡ï¼ˆå¦‚æœä¸è·³è¿‡åˆ†ç±»ï¼‰
          if [ "${{ github.event.inputs.skip_classification }}" != "true" ]; then
            if [ -z "${{ secrets.AI_API_KEY }}" ]; then
              echo "âŒ AI_API_KEY secret is not set"
              exit 1
            fi
            
            if [ -z "${{ secrets.AI_ACCOUNT_ID }}" ]; then
              echo "âŒ AI_ACCOUNT_ID secret is not set"
              exit 1
            fi
          fi
          
          echo "âœ… ç¯å¢ƒå˜é‡éªŒè¯é€šè¿‡"
      
      # 5. åˆ›å»ºå¿…è¦çš„ç›®å½•
      - name: ğŸ“ åˆ›å»ºç›®å½•ç»“æ„
        run: |
          mkdir -p data
          mkdir -p docs
          mkdir -p logs
          echo "âœ… ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ"
      
      # 6. è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒå˜é‡
      - name: âš™ï¸ é…ç½®è¿è¡Œç¯å¢ƒ
        run: |
          # ç¡®å®šè·å–æ¨¡å¼
          if [ "${{ github.event.inputs.force_full_fetch }}" = "true" ]; then
            echo "FETCH_MODE=full" >> $GITHUB_ENV
            echo "ğŸ”„ å¼ºåˆ¶å…¨é‡è·å–æ¨¡å¼"
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            echo "FETCH_MODE=incremental" >> $GITHUB_ENV
            echo "â° å®šæ—¶ä»»åŠ¡ - å¢é‡æ›´æ–°æ¨¡å¼"
          elif [ -n "${{ github.event.inputs.fetch_mode }}" ]; then
            echo "FETCH_MODE=${{ github.event.inputs.fetch_mode }}" >> $GITHUB_ENV
            echo "ğŸ‘¤ æ‰‹åŠ¨è§¦å‘ - ${{ github.event.inputs.fetch_mode }}æ¨¡å¼"
          else
            echo "FETCH_MODE=incremental" >> $GITHUB_ENV
            echo "ğŸ“ é»˜è®¤ - å¢é‡æ›´æ–°æ¨¡å¼"
          fi
          
          # è®¾ç½®æœ€å¤§ä»“åº“æ•°é‡
          if [ -n "${{ github.event.inputs.max_repositories }}" ]; then
            echo "MAX_REPOSITORIES=${{ github.event.inputs.max_repositories }}" >> $GITHUB_ENV
            echo "ğŸ“Š è‡ªå®šä¹‰æœ€å¤§ä»“åº“æ•°é‡: ${{ github.event.inputs.max_repositories }}"
          fi
          
          # è®¾ç½®å…¶ä»–ç¯å¢ƒå˜é‡
          echo "GH_PAT=${{ secrets.GH_PAT }}" >> $GITHUB_ENV
          echo "GITHUB_USERNAME=${{ secrets.GITHUB_USERNAME }}" >> $GITHUB_ENV
          echo "AI_API_KEY=${{ secrets.AI_API_KEY }}" >> $GITHUB_ENV
          echo "AI_ACCOUNT_ID=${{ secrets.AI_ACCOUNT_ID }}" >> $GITHUB_ENV
          
          echo "âœ… ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ"
      
      # 7. è·å–Staré¡¹ç›®æ•°æ®
      - name: â­ è·å–GitHub Staré¡¹ç›®
        run: |
          echo "ğŸš€ å¼€å§‹è·å–GitHub Staré¡¹ç›®..."
          echo "ğŸ“‹ è·å–æ¨¡å¼: $FETCH_MODE"
          
          python src/fetch_stars.py
          
          if [ $? -eq 0 ]; then
            echo "âœ… Staré¡¹ç›®è·å–æˆåŠŸ"
            
            # æ˜¾ç¤ºè·å–ç»Ÿè®¡
            if [ -f "data/stars_data.json" ]; then
              total_count=$(python -c "import json; data=json.load(open('data/stars_data.json')); print(len(data.get('repositories', [])))")
              echo "ğŸ“Š å½“å‰æ€»é¡¹ç›®æ•°: $total_count"
            fi
          else
            echo "âŒ Staré¡¹ç›®è·å–å¤±è´¥"
            exit 1
          fi
      
      # 8. AIåˆ†ç±»å¤„ç†
      - name: ğŸ¤– AIæ™ºèƒ½åˆ†ç±»
        if: github.event.inputs.skip_classification != 'true'
        run: |
          echo "ğŸ§  å¼€å§‹AIæ™ºèƒ½åˆ†ç±»..."
          
          python src/classify.py
          
          if [ $? -eq 0 ]; then
            echo "âœ… AIåˆ†ç±»å®Œæˆ"
            
            # æ˜¾ç¤ºåˆ†ç±»ç»Ÿè®¡
            if [ -f "data/stars_data.json" ]; then
              python -c "
import json
data = json.load(open('data/stars_data.json'))
repos = data.get('repositories', [])
classified = sum(1 for r in repos if r.get('is_classified', False))
print(f'ğŸ“Š å·²åˆ†ç±»é¡¹ç›®: {classified}/{len(repos)}')
"
            fi
          else
            echo "âŒ AIåˆ†ç±»å¤±è´¥"
            exit 1
          fi
      
      # 9. ç”Ÿæˆåˆ†ç±»æ–‡æ¡£
      - name: ğŸ“ ç”Ÿæˆåˆ†ç±»æ–‡æ¡£
        run: |
          echo "ğŸ“š å¼€å§‹ç”Ÿæˆåˆ†ç±»æ–‡æ¡£..."
          
          python src/generate_category_docs.py
          
          if [ $? -eq 0 ]; then
            echo "âœ… åˆ†ç±»æ–‡æ¡£ç”ŸæˆæˆåŠŸ"
            
            # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡æ¡£
            if [ -d "docs" ]; then
              doc_count=$(find docs -name "*.md" -type f | wc -l)
              echo "ğŸ“„ ç”Ÿæˆæ–‡æ¡£æ•°é‡: $doc_count"
              echo "ğŸ“‹ ç”Ÿæˆçš„æ–‡æ¡£:"
              find docs -name "*.md" -type f -exec basename {} \; | sort
            fi
          else
            echo "âŒ åˆ†ç±»æ–‡æ¡£ç”Ÿæˆå¤±è´¥"
            exit 1
          fi
      
      # 10. æ›´æ–°README
      - name: ğŸ“– æ›´æ–°READMEæ–‡ä»¶
        run: |
          echo "ğŸ“ å¼€å§‹æ›´æ–°README..."
          
          python src/update_readme.py
          
          if [ $? -eq 0 ]; then
            echo "âœ… READMEæ›´æ–°æˆåŠŸ"
          else
            echo "âŒ READMEæ›´æ–°å¤±è´¥"
            exit 1
          fi
      
      # 11. æ£€æŸ¥æ–‡ä»¶å˜æ›´
      - name: ğŸ” æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: check_changes
        run: |
          echo "ğŸ” æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet && git diff --cached --quiet; then
            echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            echo "ğŸ“‹ å˜æ›´çš„æ–‡ä»¶:"
            git diff --name-only
            git diff --cached --name-only
          fi
      
      # 12. æäº¤å˜æ›´
      - name: ğŸ’¾ æäº¤å˜æ›´
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ’¾ æäº¤æ–‡ä»¶å˜æ›´..."
          
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ·»åŠ å˜æ›´çš„æ–‡ä»¶
          git add data/ docs/ README.md
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          commit_msg="ğŸ¤– è‡ªåŠ¨æ›´æ–°GitHub Staré¡¹ç›®æ•°æ®"
          
          if [ "$FETCH_MODE" = "full" ]; then
            commit_msg="$commit_msg (å…¨é‡æ›´æ–°)"
          else
            commit_msg="$commit_msg (å¢é‡æ›´æ–°)"
          fi
          
          commit_msg="$commit_msg\n\n- è·å–æ¨¡å¼: $FETCH_MODE"
          commit_msg="$commit_msg\n- æ›´æ–°æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          commit_msg="$commit_msg\n- è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          
          if [ "${{ github.event.inputs.skip_classification }}" = "true" ]; then
            commit_msg="$commit_msg\n- è·³è¿‡AIåˆ†ç±»: æ˜¯"
          fi
          
          # æäº¤å˜æ›´
          git commit -m "$commit_msg"
          
          echo "âœ… å˜æ›´æäº¤æˆåŠŸ"
      
      # 13. æ¨é€å˜æ›´
      - name: ğŸš€ æ¨é€å˜æ›´
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸš€ æ¨é€å˜æ›´åˆ°è¿œç¨‹ä»“åº“..."
          
          git push
          
          if [ $? -eq 0 ]; then
            echo "âœ… å˜æ›´æ¨é€æˆåŠŸ"
          else
            echo "âŒ å˜æ›´æ¨é€å¤±è´¥"
            exit 1
          fi
      
      # 14. ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
      - name: ğŸ“Š ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
        if: always()
        run: |
          echo "ğŸ“Š ===== æ‰§è¡Œæ‘˜è¦ ====="
          echo "ğŸ• æ‰§è¡Œæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”§ è·å–æ¨¡å¼: $FETCH_MODE"
          echo "ğŸ¯ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          
          if [ "${{ github.event.inputs.skip_classification }}" = "true" ]; then
            echo "ğŸ¤– AIåˆ†ç±»: è·³è¿‡"
          else
            echo "ğŸ¤– AIåˆ†ç±»: æ‰§è¡Œ"
          fi
          
          if [ -f "data/stars_data.json" ]; then
            echo "ğŸ“ˆ æ•°æ®ç»Ÿè®¡:"
            python -c "
import json
try:
    data = json.load(open('data/stars_data.json'))
    repos = data.get('repositories', [])
    classified = sum(1 for r in repos if r.get('is_classified', False))
    print(f'  - æ€»é¡¹ç›®æ•°: {len(repos)}')
    print(f'  - å·²åˆ†ç±»: {classified}')
    print(f'  - æœªåˆ†ç±»: {len(repos) - classified}')
    if len(repos) > 0:
        print(f'  - åˆ†ç±»ç‡: {classified/len(repos)*100:.1f}%')
except Exception as e:
    print(f'  - ç»Ÿè®¡è·å–å¤±è´¥: {e}')
"
          fi
          
          if [ -d "docs" ]; then
            doc_count=$(find docs -name "*.md" -type f | wc -l)
            echo "ğŸ“š ç”Ÿæˆæ–‡æ¡£: $doc_count ä¸ª"
          fi
          
          echo "ğŸ“ æ–‡ä»¶å˜æ›´: ${{ steps.check_changes.outputs.has_changes }}"
          echo "========================"
      
      # 15. é”™è¯¯å¤„ç†å’Œæ¸…ç†
      - name: ğŸ§¹ æ¸…ç†å’Œé”™è¯¯å¤„ç†
        if: failure()
        run: |
          echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥ï¼Œå¼€å§‹æ¸…ç†..."
          
          # æ˜¾ç¤ºé”™è¯¯æ—¥å¿—
          if [ -d "logs" ]; then
            echo "ğŸ“‹ é”™è¯¯æ—¥å¿—:"
            find logs -name "*.log" -type f -exec echo "=== {} ===" \; -exec cat {} \;
          fi
          
          # æ˜¾ç¤ºPythoné”™è¯¯ä¿¡æ¯
          echo "ğŸ Pythonç¯å¢ƒä¿¡æ¯:"
          python --version
          pip list
          
          # æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
          echo "ğŸ’» ç³»ç»Ÿä¿¡æ¯:"
          uname -a
          df -h
          
          echo "ğŸ§¹ æ¸…ç†å®Œæˆ"