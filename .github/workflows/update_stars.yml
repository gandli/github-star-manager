name: Update GitHub Stars

# å·¥ä½œæµè§¦å‘æ¡ä»¶
on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯å¤©UTCæ—¶é—´3ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´11ç‚¹ï¼‰
  schedule:
    - cron: '0 3 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      fetch_mode:
        description: 'è·å–æ¨¡å¼ (incremental: å¢é‡æ›´æ–°, full: å…¨é‡æ›´æ–°)'
        required: true
        default: 'incremental'
        type: choice
        options:
          - incremental
          - full
      skip_classification:
        description: 'è·³è¿‡AIåˆ†ç±»æ­¥éª¤'
        required: false
        default: false
        type: boolean

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.11'
  PYTHONUNBUFFERED: 1
  PYTHONDONTWRITEBYTECODE: 1
  # GitHubç›¸å…³ç¯å¢ƒå˜é‡
  GH_PAT: ${{ secrets.GH_PAT }}
  GITHUB_USERNAME: ${{ github.actor }}
  # AIç›¸å…³ç¯å¢ƒå˜é‡ï¼ˆä»…åœ¨éœ€è¦æ—¶ä½¿ç”¨ï¼‰
  AI_API_KEY: ${{ secrets.AI_API_KEY }}
  AI_ACCOUNT_ID: ${{ secrets.AI_ACCOUNT_ID }}

# ä½œä¸šå®šä¹‰
jobs:
  update-stars:
    name: æ›´æ–°GitHub Staré¡¹ç›®
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    # å¹¶å‘æ§åˆ¶
    concurrency:
      group: update-stars-${{ github.ref }}
      cancel-in-progress: false
    
    # æƒé™è®¾ç½®
    permissions:
      contents: write
      actions: read
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          persist-credentials: true
      
      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
      
      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -c "import requests, yaml; print('âœ… æ ¸å¿ƒä¾èµ–éªŒè¯é€šè¿‡')"
      
      # 4. éªŒè¯ç¯å¢ƒé…ç½®
      - name: ğŸ” éªŒè¯ç¯å¢ƒé…ç½®
        run: |
          python src/env_check.py --secrets-only ${{ github.event.inputs.skip_classification == 'true' && '--skip-classification' || '' }}
      
      # 5. åˆ›å»ºå¿…è¦çš„ç›®å½•
      - name: ğŸ“ åˆ›å»ºç›®å½•ç»“æ„
        run: |
          python src/workflow_utils.py create-dirs
      
      # 6. è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒå˜é‡
      - name: âš™ï¸ é…ç½®è¿è¡Œç¯å¢ƒ
        run: |
          # ç¡®å®šè·å–æ¨¡å¼
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "FETCH_MODE=incremental" >> $GITHUB_ENV
            echo "â° å®šæ—¶ä»»åŠ¡ - å¢é‡æ›´æ–°æ¨¡å¼"
          elif [ -n "${{ github.event.inputs.fetch_mode }}" ]; then
            echo "FETCH_MODE=${{ github.event.inputs.fetch_mode }}" >> $GITHUB_ENV
            echo "ğŸ‘¤ æ‰‹åŠ¨è§¦å‘ - ${{ github.event.inputs.fetch_mode }}æ¨¡å¼"
          else
            echo "FETCH_MODE=incremental" >> $GITHUB_ENV
            echo "ğŸ“ é»˜è®¤ - å¢é‡æ›´æ–°æ¨¡å¼"
          fi
          
          echo "âœ… ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ"
      
      # 7. è·å–Staré¡¹ç›®æ•°æ®
      - name: â­ è·å–GitHub Staré¡¹ç›®
        timeout-minutes: 30
        run: |
          echo "ğŸš€ å¼€å§‹è·å–GitHub Staré¡¹ç›®..."
          echo "ğŸ“‹ è·å–æ¨¡å¼: $FETCH_MODE"
          
          if python src/fetch_stars.py; then
            echo "âœ… Staré¡¹ç›®è·å–æˆåŠŸ"
            python src/stats.py project_stats
          else
            echo "âŒ Staré¡¹ç›®è·å–å¤±è´¥"
            exit 1
          fi
      
      # 8. AIåˆ†ç±»å¤„ç†
      - name: ğŸ¤– AIæ™ºèƒ½åˆ†ç±»
        if: github.event.inputs.skip_classification != 'true'
        timeout-minutes: 30
        run: |
          echo "ğŸ§  å¼€å§‹AIæ™ºèƒ½åˆ†ç±»..."
          
          if [ -f "data/stars_data.json" ]; then
            unclassified_count=$(python src/stats.py unclassified)
            
            if [ "$unclassified_count" -eq "0" ]; then
              echo "ğŸ“ æ‰€æœ‰é¡¹ç›®å·²åˆ†ç±»ï¼Œè·³è¿‡AIåˆ†ç±»æ­¥éª¤"
            else
              echo "ğŸ“Š å‘ç° $unclassified_count ä¸ªæœªåˆ†ç±»é¡¹ç›®ï¼Œå¼€å§‹AIåˆ†ç±»..."
              
              if python src/classify.py data/stars_data.json; then
                echo "âœ… AIåˆ†ç±»å®Œæˆ"
                python src/stats.py classification
              else
                echo "âŒ AIåˆ†ç±»å¤±è´¥"
                exit 1
              fi
            fi
          else
            echo "âŒ æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡AIåˆ†ç±»"
          fi
      
      # 9. ç”Ÿæˆåˆ†ç±»æ–‡æ¡£
      - name: ğŸ“ ç”Ÿæˆåˆ†ç±»æ–‡æ¡£
        run: |
          echo "ğŸ“š å¼€å§‹ç”Ÿæˆåˆ†ç±»æ–‡æ¡£..."
          python src/generate_category_docs.py
          echo "âœ… åˆ†ç±»æ–‡æ¡£ç”Ÿæˆå®Œæˆ"
      
      # 10. æ›´æ–°README
      - name: ğŸ“– æ›´æ–°READMEæ–‡ä»¶
        run: |
          echo "ğŸ“ å¼€å§‹æ›´æ–°README..."
          python src/update_readme.py
          echo "âœ… READMEæ›´æ–°å®Œæˆ"
      
      # 11. æ£€æŸ¥æ–‡ä»¶å˜æ›´
      - name: ğŸ” æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: check_changes
        run: |
          python src/workflow_utils.py check-changes
      
      # 12. æäº¤å¹¶æ¨é€å˜æ›´
      - name: ğŸ’¾ æäº¤å¹¶æ¨é€å˜æ›´
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          python src/workflow_utils.py commit-changes "$FETCH_MODE" "${{ github.event_name }}" "${{ github.run_number }}" "${{ github.event.inputs.skip_classification }}"
          python src/workflow_utils.py push-changes
      
      # 13. ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
      - name: ğŸ“Š ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
        if: always()
        run: |
          python src/workflow_utils.py summary "${{ github.event.created_at }}" "$FETCH_MODE" "${{ github.event_name }}" "${{ github.run_number }}" "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" "${{ github.event.inputs.skip_classification }}" "${{ steps.check_changes.outputs.has_changes }}"